<!DOCTYPE html>
<html>
<head>
    <title>{% if object %}Edit Document{% else %}Upload Document{% endif %}</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .navigation-links {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-link {
            color: #667eea;
            text-decoration: none;
            padding: 10px 15px;
            border: 1px solid #667eea;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .nav-link:hover {
            background: #667eea;
            color: white;
        }
        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .help-text {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .required::after {
            content: " *";
            color: #dc3545;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation-links">
            <a href="/" class="nav-link">üè† Go to Home</a>
            <a href="{% url 'documents:document_list' %}" class="nav-link">üìÇ Back to Documents</a>
        </div>
        
        <div class="form-card">
            <div class="form-header">
                <h1 style="color: #2c3e50; margin-bottom: 10px;">
                    {% if object %}‚úèÔ∏è Edit Document{% else %}üì§ Upload New Document{% endif %}
                </h1>
                <p style="color: #6c757d;">
                    {% if object %}
                    Update the document information below
                    {% else %}
                    Fill in the document details to upload a new file
                    {% endif %}
                </p>
            </div>

            <div class="info-box">
                <h4>üîí Security Notice</h4>
                <p style="margin: 0; color: #0066cc; font-size: 0.9em;">
                    All documents are <strong>restricted by default</strong> for enhanced security. 
                    Only authorized users will be able to access this document.
                </p>
            </div>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_title" class="required">Document Title</label>
                    <input type="text" id="id_title" name="title" class="form-control" 
                           value="{{ form.title.value|default:'' }}" 
                           placeholder="Enter document title" required>
                    <div class="help-text">A clear, descriptive title for the document</div>
                </div>

                <div class="form-group">
                    <label for="id_category" class="required">Document Category</label>
                    <select id="id_category" name="category" class="form-control" required>
                        <option value="">Select Category</option>
                        {% for value, label in form.category.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" 
                                    {% if form.category.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <div class="help-text">Select the category for this document</div>
                </div>

                <div class="form-group" id="audit-type-group" style="display: none;">
                    <label for="id_audit_type">Audit Type</label>
                    <select id="id_audit_type" name="audit_type" class="form-control">
                        <option value="">Select Audit Type</option>
                        {% for value, label in form.audit_type.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" 
                                    {% if form.audit_type.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <div class="help-text">Required only for Audit Reports</div>
                </div>
                
                <div class="form-group">
                    <label for="id_audit_period" class="required">Audit Period</label>
                    <select id="id_audit_period" name="audit_period" class="form-control" required>
                        <option value="">Select Audit Period</option>
                        {% for period in audit_periods %}
                            <option value="{{ period.id }}" 
                                    {% if form.audit_period.value == period.id %}selected{% endif %}>
                                {{ period.fiscal_year }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="help-text">Select the fiscal year for this document</div>
                </div>
                
                <div class="form-group">
                    <label for="id_quarter" class="required">Quarter</label>
                    <select id="id_quarter" name="quarter" class="form-control" required>
                        <option value="">Select Quarter</option>
                        {% for value, label in form.quarter.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" 
                                    {% if form.quarter.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <div class="help-text">Select the quarter for this document</div>
                </div>
                
                <div class="form-group">
                    <label for="id_pdf_file" class="required">PDF File</label>
                    <input type="file" id="id_pdf_file" name="pdf_file" class="form-control" 
                           accept=".pdf" {% if not object %}required{% endif %}>
                    <div class="help-text">
                        Upload a PDF file (Max size: 10MB)
                        {% if object and object.pdf_file %}
                        <br>Current file: <a href="{{ object.pdf_file.url }}" target="_blank">{{ object.pdf_file.name }}</a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Restricted Access Section - Hidden but always enabled -->
                <input type="hidden" name="restricted" value="true">
                
                <div class="form-group">
                    <div class="info-box" style="background: #fff3cd; border-color: #ffeaa7;">
                        <h4>üîê Access Control</h4>
                        <p style="margin: 0; color: #856404; font-size: 0.9em;">
                            This document is <strong>restricted by default</strong>. 
                            Only you (as the uploader) and administrators can access it.
                            You can optionally grant access to specific users below.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="id_allowed_users">Grant Access to Additional Users</label>
                    <select id="id_allowed_users" name="allowed_users" class="form-control" multiple 
                            style="height: 120px;">
                        {% for user in form.allowed_users.field.queryset %}
                            <option value="{{ user.id }}" 
                                    {% if user.id in form.allowed_users.value %}selected{% endif %}>
                                {{ user.get_full_name|default:user.username }} - {{ user.email }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="help-text">
                        Optional: Select additional users who should have access to this document. 
                        Hold Ctrl/Cmd to select multiple users. 
                        <strong>Note:</strong> You and administrators will always have access.
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        {% if object %}Update Document{% else %}Upload Document{% endif %}
                    </button>
                    <a href="{% url 'documents:document_list' %}" class="nav-link" style="margin-left: 15px;">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide/show audit type based on category selection
            const categorySelect = document.getElementById('id_category');
            const auditTypeGroup = document.getElementById('audit-type-group');
            
            function toggleAuditType() {
                if (categorySelect.value === 'AUDIT_REPORTS') {
                    auditTypeGroup.style.display = 'block';
                    // Make audit type required for audit reports
                    document.getElementById('id_audit_type').required = true;
                } else {
                    auditTypeGroup.style.display = 'none';
                    // Remove required attribute for non-audit reports
                    document.getElementById('id_audit_type').required = false;
                    document.getElementById('id_audit_type').value = '';
                }
            }
            
            // Initial setup
            toggleAuditType();
            
            // Event listener for category changes
            categorySelect.addEventListener('change', toggleAuditType);
            
            // File input validation
            const fileInput = document.getElementById('id_pdf_file');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        // Check file type
                        if (file.type !== 'application/pdf') {
                            alert('Please select a PDF file.');
                            this.value = '';
                            return;
                        }
                        
                        // Check file size (10MB limit)
                        if (file.size > 10 * 1024 * 1024) {
                            alert('File size must be less than 10MB.');
                            this.value = '';
                            return;
                        }
                    }
                });
            }
            
            // Form submission handling
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                // Validate category and audit type
                const category = document.getElementById('id_category').value;
                const auditType = document.getElementById('id_audit_type').value;
                
                if (category === 'AUDIT_REPORTS' && !auditType) {
                    e.preventDefault();
                    alert('Audit Type is required for Audit Reports.');
                    document.getElementById('id_audit_type').focus();
                    return;
                }
                
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.innerHTML = '‚è≥ ' + (submitButton.innerHTML.includes('Update') ? 'Updating...' : 'Uploading...');
                submitButton.disabled = true;
            });
        });
    </script>
</body>
</html>